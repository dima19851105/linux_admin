# Домашнее задание №6
## Условие

    1. Попасть в систему без пароля несколькими способами
    2. Установить систему с LVM, после чего переименовать VG
    3. Добавить модуль в initrd
    4. (*). Сконфигурировать систему без отдельного раздела с /boot, а только с LVM
       Репозиторий с пропатченым grub: https://yum.rumyantsev.com/centos/7/x86_64/
       PV необходимо инициализировать с параметром --bootloaderareasize 1m

## 1. Попасть в систему без пароля несколькими способами
### Способ №1

1. Необходимо воспользоваться загрузочным диском RHEL/CentOS и загрузиться с него.
2. Выбрать Troubleshooting
3. Выбрать Rescue a *Red Hat Enterprise Linux/CentOS* System
4. Выбрать Continue
5. OK
6. chroot /mnt/sysimage
7. Если вносились изменения, необходимо выполнить команду

        rm -f /.autorelabel

### Способ №2

1. Во время старта системы, когда появляется выбор загрузки версии ядра, нажать **e**
2. В строке, которая начинается на *linux16/linuxefi*, удалить параметры rhgb и quiet. Вместо удаленных параметров указать rd.break
3. Нажать Ctrl+x
4. Загрузится initramfs, корневая ФС будет смонтирована в read-only режиме в /sysroot
5. Монтируем корневую ФС в read-write режиме

        mount -o remount,rw /sysroot

6. chroot /sysroot
7. Если вносились изменения, необходимо выполнить команду

        touch /.autorelabel

8. Перед выходом перевести ФС обратно в режим read-only

        mount -o remount,ro /

### Способ №3

1. Загрузиться с live cd
2. Создать каталог для монтирования
3. Монтировать устройство на котором находится **/** в созданный каталог
4. Использовать chroot

### Способ №4

1. Во время старта системы, когда появляется выбор загрузки версии ядра, нажать **e**
2. В конец строки, которая начинается на *linux16/linuxefi*, добавить *init=/bin/sh* или *init=/bin/bash*
3. Нажать Ctrl+x
4. Корневая ФС монтируется в режиме read-only, поэтому её необходимо перевести в режим read-write с помощью команды

        mount -o remount,rw /

5. Если вносились изменения, необходимо выполнить команду

        touch ./autorelabel


### Способ №5
 
1. Во время старта системы, когда появляется выбор загрузки версии ядра, нажать **e**
2. В строке, которая начинается на *linux16/linuxefi*, заменить *ro* на *rw init=/sysroot/bin/sh*
3. Нажать Ctrl+x
4. Корневая ФС смонтирова в режиме read-write
5. Если вносились изменения, необходимо выполнить команду

        touch ./autorelabel

### Различия между способами доступа к shell

Способ 1. Загрузка с диска в Rescue режиме
Способ 2. При помощи параметра *rd.break* загрузка останавливается на этапе работы *initramfs*
Способ 3. Загрузка с стороннего live-cd
Способ 4. При помощи параметра *init=/bin/sh* ядру указывается путь к программе инициализации, которая будет запущена после того, как initramfs закончит работу.
          В данном случае это будет /bin/sh, можно например указать /bin/bash. При обычной загрузке используется система инициализации systemd
Способ 5. При помощи параметра *init=/sysroot/bin/sh* ядру указывается путь к программе инициализации, которая будет запущена после того, как initramfs закончит работу.
          В данном случае это будет /sysroot/bin/sh, параметр rw указывает, что необходимо смонтировать корневую ФС в режиме чтения-записи.

## 2. Установить систему с LVM, после чего переименовать VG

У меня способ описанный в методичке не сработал, система при перезагрузке ОС не загружается (черный экран)
Нашел другой способ, [ссылка на базу знаний RHEL](https://access.redhat.com/solutions/1573673)

1. Переименовываем VG
    
        vgrename oldvg newvg

2. Изменяем данные в */etc/fstab*
3. В файле */etc/default/grub*, в строке *GRUB_CMDLINE_LINUX* вносим изменения
4. Активируема VG

        vgchange -ay

5. Делаем бэкап текущего *initramfs* и пересобираем его

        cp /boot/initramfs-$(uname -r).img /boot/initramfs-$(uname -r).img.$(date +%m-%d-%H%M%S).bak
        dracut -v -f /boot/initramfs-$(uname -r).img $(uname -r)

6. Затем необходимо загрузиться в rescue режиме и пересобрать *grub2*. Для этого вставляем загрузочный CD -> Troubleshooting -> Rescue -> Continue

        chroot /mnt/sysimage
        grub2-mkconfig -o /boot/grub2/grub.cfg

  Либо при старте системы сойти в меню grub2, нажав *е*, в строке которая начинается на linux16 заменить старое название VG на новое. Загрузиться и выполнить

        grub2-mkconfig -o /boot/grub2/grub.cfg

Результат после переименования VG

![rename-vg](https://github.com/parshyn-dima/screens/blob/master/lesson06/rename-vg.png)

## 3. Добавить модуль в initrd

Необходимо скачать из данного репозитория GitHub каталог Lesson_6 и перейти в него, далее необходимо выполнить

    vagrant up

Далее необходимо войти в созданную ВМ

    vagrant ssh

Перезапустить ВМ и открыть ВМ из virtualbox, чтобы увидеть процесс загрузки.

![install-module](https://github.com/parshyn-dima/screens/blob/master/lesson06/install-module.png)
